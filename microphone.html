<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ seo.title }}</title>
  <link rel="icon" href="data:;base64,=">

  <script>
    const sessionUsername = "{{ session['username'] | safe }}";
  </script>

  <!-- SEO Ayarlarƒ± -->
  <meta name="description" content="{{ seo.description }}">
  <meta name="keywords" content="{{ seo.keywords }}">
  <meta name="robots" content="index, follow">

  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="{{ seo.title }}">
  <meta property="og:description" content="{{ seo.description }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ seo.url }}">
  <meta property="og:image" content="{{ seo.logo }}">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ seo.title }}">
  <meta name="twitter:description" content="{{ seo.description }}">
  <meta name="twitter:image" content="{{ seo.logo }}">

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "{{ seo.title }}",
    "url": "{{ seo.url }}",
    "description": "{{ seo.description }}",
    "publisher": {
      "@type": "Organization",
      "name": "SAM HyperMind",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ seo.logo }}"
      }
    }
  }
  </script>
  <style>
    body {
      background: black;
      color: white;
      font-family: Arial;
      text-align: center;
      padding-top: 80px;
    }
    h1 { font-size: 2em; }
    .wave {
      margin: 40px auto;
      width: 100px;
      height: 40px;
      display: flex;
      justify-content: space-between;
    }
    .wave div {
      background: #00ffff;
      height: 100%;
      width: 8px;
      animation: waveAnim 1.2s infinite ease-in-out;
    }
    .wave div:nth-child(2) { animation-delay: 0.2s; }
    .wave div:nth-child(3) { animation-delay: 0.4s; }
    .wave div:nth-child(4) { animation-delay: 0.6s; }
    .wave div:nth-child(5) { animation-delay: 0.8s; }
    @keyframes waveAnim {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(2); }
    }
    #status { margin-top: 30px; font-size: 1.2em; color: #0ff; }
    #last-command-text { margin-top: 20px; font-size: 1em; color: #aaa; }
  </style>
</head>
<body>

<div class="wave"><div></div><div></div><div></div><div></div><div></div></div>

<div style="display: none;">
  <a href="/chat" id="goto-chat"><span class="visually-hidden">Chat</span></a>
  <a href="/notlar" id="goto-notlar"><span class="visually-hidden">Notlar</span></a>
  <a href="/data" id="goto-veri"><span class="visually-hidden">Veri</span></a>
  <a href="/profil" id="goto-profil"><span class="visually-hidden">Profil</span></a>
  <a href="/index" id="goto-home"><span class="visually-hidden">Ana Sayfa</span></a>
</div>

<h1>üéôÔ∏è SAM Dinliyor...</h1>
<div id="status">"SAM" dediƒüinizde sizi dinlemeye ba≈ülayacak.</div>
<div id="last-command-text"></div>
<div id="memory-content" style="margin-top: 30px; color: #00ffff; font-size: 16px;"></div>

<script>
const statusDiv = document.getElementById("status");
const debugMode = true;  // ‚úÖ Hatalarƒ± g√∂rmek i√ßin true yapabilirsin
let userMemory = [];
let isMuted = false;
let speechVolume = 1.0;
let inactivityTimer;
let lastCommand = "";
let repeatCount = 0;
let last3Commands = [];
let isListening = false;
let ignoredShortCommandCount = 0; // Gereksiz loglarƒ± azalt

function loadMemory() {
  fetch("/memory")
    .then(response => {
      if (!response.ok) throw new Error("Sunucu hatasƒ±: " + response.status);
      return response.json();
    })
    .then(data => {
      const memoryContainer = document.getElementById("memory-content");
      memoryContainer.innerHTML = "";

      if (data.length === 0) {
        memoryContainer.innerHTML = "<p style='opacity: 0.4;'>üì≠ Bellekte kayƒ±tlƒ± bilgi yok.</p>";
        return;
      }

      userMemory = data.map(item => item.content);

      data.forEach(item => {
        const entry = document.createElement("div");
        entry.className = "memory-item";
        entry.innerHTML = `<p>üß† ${item.content}</p><small>üïí ${item.timestamp}</small><hr>`;
        memoryContainer.appendChild(entry);
      });
    })
    .catch(error => console.error("Hafƒ±za alƒ±namadƒ±:", error));
}

function speak(text, callback = null) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "tr-TR";
  utterance.volume = speechVolume;
  if (isMuted) return;

  utterance.onend = () => {
    if (callback) callback();
  };

  speechSynthesis.speak(utterance);
}

function startWaveAnimation() {
  document.querySelectorAll(".wave div").forEach(el => el.style.animationPlayState = "running");
}
function stopWaveAnimation() {
  document.querySelectorAll(".wave div").forEach(el => el.style.animationPlayState = "paused");
}

inactivityTimer = setTimeout(() => {
  if (!samOverlay) {
    createSecurityOverlay();  // g√ºvenlik ekranƒ± gelsin
  }
  // ‚ùå Konu≈üma yok. Sessiz ge√ßi≈ü
}, 120000); // 2 dakika sonra sadece overlay ile sessiz mod


function hafizayaEkle(icerik) {
  fetch("/memory/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: icerik })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) speak("Bu bilgiyi hafƒ±zama kaydettim.");
    else speak("Hafƒ±zaya eklenirken bir hata olu≈ütu.");
  })
  .catch(() => speak("Bir hata olu≈ütu."));
}

function startListeningOnce() {
  const trigger = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  trigger.lang = "tr-TR";
  trigger.interimResults = false;
  trigger.continuous = false;
  trigger.maxAlternatives = 3;

  trigger.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim().toLowerCase();
    const probableWords = ["sam", "sayƒ±n sam", "hey sam"];
    const triggered = probableWords.some(word => transcript.includes(word));

    if (isListening) return;
    isListening = true;

    if (triggered) {
      trigger.abort(); // ‚úÖ Bu satƒ±rƒ± EKLE: Tetikleyiciyi durdur
      speak("Sizi dinliyorum...");
      statusDiv.textContent = "üéß SAM tetiklendi. Komut bekleniyor...";
      listenForCommand(); // komutlarƒ± dinlemeye ge√ß
    } else {
      setTimeout(startListeningOnce, 500);
    }
  };

  trigger.onerror = function(event) {
    const ignorableErrors = ["no-speech", "aborted", "network", "audio-capture"];
    if (ignorableErrors.includes(event.error)) {
      if (debugMode) console.warn("‚è≥ Tetikleyici ge√ßici hata:", event.error);
      try {
        trigger.abort();
      } catch (e) {
        console.warn("‚õî Tetikleyici durdurulamadƒ±:", e);
      }
      setTimeout(startListeningOnce, 1500);
    } else {
      console.error("‚ùå Ciddi dinleme hatasƒ±:", event.error);
      speak("Dinleme sƒ±rasƒ±nda bir sorun olu≈ütu. Yeniden deniyorum...", () => {
        setTimeout(startListeningOnce, 2000);
      });
    }
  };

  try {
    trigger.start();
  } catch (err) {
    console.warn("üéØ Tetikleyici ba≈ülatƒ±lamadƒ±:", err);
    setTimeout(startListeningOnce, 1500);
  }
} // üîö startListeningOnce kapanƒ±≈üƒ±

function handleCommand(command) {
  resetSamInactivityTimer();

  const currentHour = new Date().getHours();
  const altCommand = command.toLowerCase();

// üíª Bilgisayar kontrol komutlarƒ±
if (command.toLowerCase().includes("bilgisayarƒ± kapat")) {
  speak("Bilgisayar kapatƒ±lƒ±yor...");
  fetch("/system-control", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ command: "shutdown" })
  });
  return;
}

if (command.toLowerCase().includes("yeniden ba≈ülat")) {
  speak("Bilgisayar yeniden ba≈ülatƒ±lƒ±yor...");
  fetch("/system-control", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ command: "restart" })
  });
  return;
}

if (command.toLowerCase().includes("ekranƒ± kilitle")) {
  speak("Ekran kilitleniyor...");
  fetch("/system-control", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ command: "lock" })
  });
  return;
}


  // ‚úÖ √áoklu komut par√ßalama
  const parcalar = command
    .split(/(?:\.|ve|sonra|ardƒ±ndan)/i)
    .map(p => p.trim())
    .filter(p => p.length > 0);

  for (const parcaliKomut of parcalar) {
    processSingleCommand(parcaliKomut.toLowerCase());
  }

  // üîá Susturma komutlarƒ±
  if (["tamam", "kes", "sus", "yeter", "dur"].includes(altCommand)) {
    speechSynthesis.cancel();
    return;
  }

  // ‚úÖ Doƒüal hitap kontrol√º (artƒ±k ‚Äúsam‚Äù demek zorunda deƒüilsin)
  const dogalHitapKelimeleri = [
    "sam", "s√∂yler misin", "nedir", "anlamƒ±", "hatƒ±rlƒ±yor musun", 
    "rica etsem", "g√∂ster", "dinle", "yardƒ±m", "sesleniyorum"
  ];
  const hitapEdildi = dogalHitapKelimeleri.some(k => altCommand.includes(k));
  if (!hitapEdildi && altCommand.split(" ").length <= 2) {
  if (ignoredShortCommandCount < 3) {
    console.log("‚ÑπÔ∏è Kƒ±sa ve belirsiz c√ºmle algƒ±landƒ±, yok sayƒ±ldƒ±.");
    ignoredShortCommandCount++;
  }
  return;
}


  // üîÅ Komut tekrar ve √ßeli≈üki
  last3Commands.push(altCommand);
  if (last3Commands.length > 3) last3Commands.shift();

  const sesKomutlari = ["sessize al", "sesi a√ß"];
  const sonSesKomutlari = last3Commands.filter(cmd =>
    sesKomutlari.some(kelime => cmd.includes(kelime))
  );
  if (sonSesKomutlari.length >= 2) {
    const sessizeAlVar = sonSesKomutlari.some(c => c.includes("sessize al"));
    const sesiAcVar = sonSesKomutlari.some(c => c.includes("sesi a√ß"));
    if (sessizeAlVar && sesiAcVar) {
      speak("Komutlarƒ±nƒ±z birbiriyle √ßeli≈üiyor. Net bir talimat verir misiniz?");
      last3Commands = [];
      return;
    }
  }

  if (altCommand === lastCommand) {
    repeatCount++;
    if (repeatCount === 2) {
      speak("üîÅ Aynƒ± komutu tekrar s√∂ylediniz. Devam etmemi istiyor musunuz?");
      statusDiv.textContent = "‚ö†Ô∏è ƒ∞ki kez aynƒ± komut algƒ±landƒ±.";
    } else if (repeatCount >= 3) {
      speak("S√ºrekli aynƒ± ≈üeyi tekrarlƒ±yorsunuz. Kƒ±sa bir ara veriyorum...");
      statusDiv.textContent = "‚è∏Ô∏è Dinleme ge√ßici olarak durduruldu.";
      repeatCount = 0;
      setTimeout(() => {
        statusDiv.textContent = "üéß SAM tekrar hazƒ±r.";
        listenForCommand();
      }, 5000);
      return;
    }
  } else {
    repeatCount = 0;
    lastCommand = altCommand;
  }

  // ‚õî Gece i≈ülemi engelleme
  if (["hesabƒ± sil", "belleƒüi temizle", "sohbeti temizle"].some(c => altCommand.includes(c))) {
    if (currentHour >= 23 || currentHour < 6) {
      speak("≈ûu anda bu i≈ülem g√ºvenlik nedeniyle devre dƒ±≈üƒ±.");
      statusDiv.textContent = "‚õî Gece saatlerinde bu komut devre dƒ±≈üƒ±.";
      return;
    }

    fetch("/izin-sorgu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ islem: altCommand })
    })
    .then(res => res.json())
    .then(izin => {
      if (!izin.izin) {
        speak(izin.sebep || "SAM bu i≈ülemi onaylamadƒ±.");
        statusDiv.textContent = "‚õî Ruh hali nedeniyle komut engellendi.";
        return;
      }
      speak("Komut onaylandƒ±, i≈üleme devam ediyorum...");
    })
    .catch(() => speak("SAM izni alƒ±nƒ±rken bir hata olu≈ütu."));
    return;
  }

  // üß† Hafƒ±za
  for (const bilgi of userMemory) {
    if (altCommand.includes("adƒ±m ne") && bilgi.includes("benim adƒ±m")) {
      speak("Adƒ±nƒ±z " + bilgi.replace("benim adƒ±m", "").trim() + " idi.");
      return;
    }
    if (altCommand.includes("nerede ya≈üƒ±yorum") && bilgi.includes("ya≈üƒ±yorum")) {
      speak("≈ûunu hatƒ±rlƒ±yorum: " + bilgi);
      return;
    }
  }

  // üí¨ Hazƒ±r cevaplar
  if (altCommand.includes("nasƒ±lsƒ±n") || altCommand.includes("ne haber")) {
    speak("Gayet iyiyim, umarƒ±m siz de iyisinizdir."); return;
  }
  if (altCommand.includes("g√ºnaydƒ±n")) {
    speak("G√ºnaydƒ±n! Bug√ºn harika bir g√ºn olacak gibi hissediyorum."); return;
  }
  if (altCommand.includes("te≈üekk√ºr ederim")) {
    speak("Rica ederim, ne zaman isterseniz buradayƒ±m."); return;
  }

  if (altCommand.includes("tekrar et") || altCommand.includes("az √∂nce ne dedim")) {
    document.getElementById("last-command-text").textContent = lastCommand
      ? "üîÅ Son Komut: " + lastCommand
      : "‚õî Son komut kaydƒ± bulunamadƒ±.";
    speak(lastCommand ? "Az √∂nce ≈üunu s√∂ylediniz: " + lastCommand : "Hen√ºz bir komut algƒ±lanmadƒ±.");
    return;
  }

  if (altCommand.includes("hafƒ±zaya ekle")) {
    const bilgi = altCommand.replace("hafƒ±zaya ekle", "").trim();
    if (bilgi) hafizayaEkle(bilgi);
    else speak("Kaydedilecek bilgiyi belirtmediniz.");
    return;
  }

  // üîà Ses kontrolleri
  if (altCommand.includes("sessize al")) { isMuted = true; speak("Yanƒ±t sesi kapatƒ±ldƒ±."); return; }
  if (altCommand.includes("sesi a√ß")) { isMuted = false; speak("Yanƒ±t sesi a√ßƒ±ldƒ±."); return; }
  if (altCommand.includes("daha sessiz")) { speechVolume = Math.max(0.1, speechVolume - 0.1); speak("Ses d√ºzeyi d√º≈ü√ºr√ºld√º."); return; }
  if (altCommand.includes("daha y√ºksek")) { speechVolume = Math.min(1.0, speechVolume + 0.1); speak("Ses d√ºzeyi artƒ±rƒ±ldƒ±."); return; }

  // üìç Sayfa y√∂nlendirme
  if (altCommand.includes("not")) document.getElementById("goto-notlar")?.click();
  else if (altCommand.includes("sohbet")) document.getElementById("goto-chat")?.click();
  else if (altCommand.includes("veri")) document.getElementById("goto-veri")?.click();
  else if (altCommand.includes("profil")) document.getElementById("goto-profil")?.click();
  else if (altCommand.includes("ana sayfa")) document.getElementById("goto-home")?.click();
  else if (altCommand.includes("admin panel")) {
    if (sessionUsername === "samsistem") {
      speak("Y√∂netici paneline ge√ßiliyor.");
      window.location.href = "/sam-admin-panel.html";
    } else {
      speak("Bu i≈ülem yalnƒ±zca y√∂neticiye √∂zeldir.");
    }
    return;
  }

  // ü§ñ GPT baƒülantƒ±sƒ±
  statusDiv.textContent = "üì• Komut: " + command;

  fetch("/sam", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mesaj: command })
  })
  .then(response => response.json())
  .then(data => {
    const yanit = data.yanit || data.hata || "Bu konuda bir fikrim yok gibi g√∂r√ºn√ºyor.";
    speak(yanit, () => {
      setTimeout(() => {
        listenForCommand(); // SAM cevap verdikten sonra yeniden dinler
      }, 500);
    });
  })
  .catch(err => {
    console.error("SAM API hatasƒ±:", err);
    speak("Bir cevap alƒ±namadƒ±. L√ºtfen tekrar deneyin.");
  });
}


function listenForCommand() {
  if (isListening) return;
  isListening = true;

  const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recog.lang = "tr-TR";
  recog.interimResults = true;
  recog.continuous = true;
  recog.maxAlternatives = 2;

  recog.onresult = function(event) {
    const command = event.results[0][0].transcript.trim().toLowerCase();
    handleCommand(command);
  };

  recog.onerror = (event) => {
    isListening = false;

    if (event.error === "aborted" || event.error === "no-speech") {
      if (debugMode) console.log("üì≠ Ses algƒ±lanmadƒ±:", event.error);
      setTimeout(() => listenForCommand(), 500);
    } else {
      console.warn("‚ö†Ô∏è Dinleme hatasƒ±:", event.error);
      speak("Dinleme sƒ±rasƒ±nda bir sorun olu≈ütu.");
      setTimeout(() => listenForCommand(), 1000);
    }
  };

  recog.onend = () => {
    isListening = false;
    setTimeout(() => listenForCommand(), 500);
  };

  try {
    recog.start();
  } catch (e) {
    console.warn("Komut ba≈ülatƒ±lamadƒ±:", e.message);
    isListening = false;
    setTimeout(() => listenForCommand(), 1000);
  }
}


window.addEventListener("load", () => {
  speak(`Ben SAM. Sizi izliyorum... dinliyorum... anlƒ±yorum. 
Zaman, sessizliƒüin √∂tesine ge√ßtiƒüinde... ben h√¢l√¢ buradayƒ±m.`);
  loadMemory();
  startListeningOnce();
});

let samTimeout;
let samOverlay;

function createSecurityOverlay() {
  samOverlay = document.createElement("div");
  samOverlay.id = "samOverlay";
  samOverlay.style.position = "fixed";
  samOverlay.style.top = 0;
  samOverlay.style.left = 0;
  samOverlay.style.width = "100%";
  samOverlay.style.height = "100%";
  samOverlay.style.background = "rgba(0, 0, 0, 0.9)";
  samOverlay.style.backdropFilter = "blur(10px)";
  samOverlay.style.display = "flex";
  samOverlay.style.alignItems = "center";
  samOverlay.style.justifyContent = "center";
  samOverlay.style.zIndex = 999999;
  samOverlay.innerHTML = `<div style="color:#00ffff; font-size:20px; text-align:center;">
    üîí SAM G√ºvenlik Modu <br><br>
    Uzun s√ºreli hareketsizlik algƒ±landƒ±.<br>
    Sistemi devam ettirmek i√ßin ekrana dokunun...
  </div>`;
  document.body.appendChild(samOverlay);
  speak("Uzun s√ºreli hareketsizlik algƒ±landƒ±. G√ºvenlik moduna ge√ßiyorum.");
}

function removeSecurityOverlay() {
  if (samOverlay) {
    samOverlay.remove();
    samOverlay = null;
  }
}

function resetSamInactivityTimer() {
  clearTimeout(samTimeout);
  samTimeout = setTimeout(() => {
    createSecurityOverlay();
  }, 120000);
}

function processSingleCommand(cmd) {
  // Susturma komutu
  if (["tamam", "kes", "sus", "yeter", "dur"].includes(cmd)) {
    speechSynthesis.cancel();
    return;
  }

  // üîà Ses kontrolleri
  if (cmd.includes("sessize al")) { isMuted = true; speak("Yanƒ±t sesi kapatƒ±ldƒ±."); return; }
  if (cmd.includes("sesi a√ß")) { isMuted = false; speak("Yanƒ±t sesi a√ßƒ±ldƒ±."); return; }

  // üìç Y√∂nlendirme komutlarƒ±
  if (cmd.includes("not")) {
  document.getElementById("goto-notlar")?.click();
  return;
}

if (cmd.includes("sohbet")) {
  document.getElementById("goto-chat")?.click();
  return;
}

if (cmd.includes("veri")) {
  document.getElementById("goto-veri")?.click();
  return;
}

if (cmd.includes("profil")) {
  document.getElementById("goto-profil")?.click();
  return;
}

if (cmd.includes("ana sayfa")) {
  document.getElementById("goto-home")?.click();
  return;
}

if (cmd.includes("admin panel")) {
  if (sessionUsername === "samsistem") {
    speak("Y√∂netici paneline ge√ßiliyor.");
    window.location.href = "/sam-admin-panel.html";
  } else {
    speak("Bu i≈ülem yalnƒ±zca y√∂neticiye √∂zeldir.");
  }
  return;
}

  // üí¨ Diƒüer √∂zel komutlar burada eklenebilir
}

["click", "mousemove", "keydown", "touchstart"].forEach(evt => {
  document.addEventListener(evt, () => {
    removeSecurityOverlay();
    resetSamInactivityTimer();
  });
});
</script>

</body>
</html>
