<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¤ SAM Voice Assistant</title>
<link rel="icon" href="data:;base64,=">
  <script>
    const sessionUsername = "{{ session['username'] | safe }}";
  </script>
  <style>
    body {
      background: black;
      color: white;
      font-family: Arial;
      text-align: center;
      padding-top: 80px;
    }
    h1 { font-size: 2em; }
    .wave {
      margin: 40px auto;
      width: 100px;
      height: 40px;
      display: flex;
      justify-content: space-between;
    }
    .wave div {
      background: #00ffff;
      height: 100%;
      width: 8px;
      animation: waveAnim 1.2s infinite ease-in-out;
    }
    .wave div:nth-child(2) { animation-delay: 0.2s; }
    .wave div:nth-child(3) { animation-delay: 0.4s; }
    .wave div:nth-child(4) { animation-delay: 0.6s; }
    .wave div:nth-child(5) { animation-delay: 0.8s; }
    @keyframes waveAnim {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(2); }
    }
    #status { margin-top: 30px; font-size: 1.2em; color: #0ff; }
    #last-command-text { margin-top: 20px; font-size: 1em; color: #aaa; }
  </style>
</head>
<body>

<div class="wave"><div></div><div></div><div></div><div></div><div></div></div>

<div style="display: none;">
  <a href="/chat" id="goto-chat"><span class="visually-hidden">Chat</span></a>
  <a href="/notlar" id="goto-notlar"><span class="visually-hidden">Notlar</span></a>
  <a href="/data" id="goto-veri"><span class="visually-hidden">Veri</span></a>
  <a href="/profil" id="goto-profil"><span class="visually-hidden">Profil</span></a>
  <a href="/index" id="goto-home"><span class="visually-hidden">Ana Sayfa</span></a>
</div>

<h1>ğŸ™ï¸ SAM Dinliyor...</h1>
<div id="status">"SAM" dediÄŸinizde sizi dinlemeye baÅŸlayacak.</div>
<div id="last-command-text"></div>
<div id="memory-content" style="margin-top: 30px; color: #00ffff; font-size: 16px;"></div>

<script>
const statusDiv = document.getElementById("status");
const debugMode = true;  // âœ… HatalarÄ± gÃ¶rmek iÃ§in true yapabilirsin
let userMemory = [];
let isMuted = false;
let speechVolume = 1.0;
let inactivityTimer;
let lastCommand = "";
let repeatCount = 0;
let last3Commands = [];
let isListening = false;
let ignoredShortCommandCount = 0; // Gereksiz loglarÄ± azalt

function loadMemory() {
  fetch("/memory")
    .then(response => {
      if (!response.ok) throw new Error("Sunucu hatasÄ±: " + response.status);
      return response.json();
    })
    .then(data => {
      const memoryContainer = document.getElementById("memory-content");
      memoryContainer.innerHTML = "";

      if (data.length === 0) {
        memoryContainer.innerHTML = "<p style='opacity: 0.4;'>ğŸ“­ Bellekte kayÄ±tlÄ± bilgi yok.</p>";
        return;
      }

      userMemory = data.map(item => item.content);

      data.forEach(item => {
        const entry = document.createElement("div");
        entry.className = "memory-item";
        entry.innerHTML = `<p>ğŸ§  ${item.content}</p><small>ğŸ•’ ${item.timestamp}</small><hr>`;
        memoryContainer.appendChild(entry);
      });
    })
    .catch(error => console.error("HafÄ±za alÄ±namadÄ±:", error));
}

function speak(text, callback = null) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "tr-TR";
  utterance.volume = speechVolume;
  if (isMuted) return;

  utterance.onend = () => {
    if (callback) callback();
  };

  speechSynthesis.speak(utterance);
}

function startWaveAnimation() {
  document.querySelectorAll(".wave div").forEach(el => el.style.animationPlayState = "running");
}
function stopWaveAnimation() {
  document.querySelectorAll(".wave div").forEach(el => el.style.animationPlayState = "paused");
}

inactivityTimer = setTimeout(() => {
  if (!samOverlay) {
    createSecurityOverlay();  // gÃ¼venlik ekranÄ± gelsin
  }
  // âŒ KonuÅŸma yok. Sessiz geÃ§iÅŸ
}, 120000); // 2 dakika sonra sadece overlay ile sessiz mod


function hafizayaEkle(icerik) {
  fetch("/memory/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: icerik })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) speak("Bu bilgiyi hafÄ±zama kaydettim.");
    else speak("HafÄ±zaya eklenirken bir hata oluÅŸtu.");
  })
  .catch(() => speak("Bir hata oluÅŸtu."));
}

function startListeningOnce() {
  const trigger = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  trigger.lang = "tr-TR";
  trigger.interimResults = false;
  trigger.continuous = false;
  trigger.maxAlternatives = 3;

  trigger.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim().toLowerCase();
    const probableWords = ["sam", "sayÄ±n sam", "hey sam"];
    const triggered = probableWords.some(word => transcript.includes(word));

    if (isListening) return;
    isListening = true;

    if (triggered) {
      trigger.abort(); // âœ… Bu satÄ±rÄ± EKLE: Tetikleyiciyi durdur
      speak("Sizi dinliyorum...");
      statusDiv.textContent = "ğŸ§ SAM tetiklendi. Komut bekleniyor...";
      listenForCommand(); // komutlarÄ± dinlemeye geÃ§
    } else {
      setTimeout(startListeningOnce, 500);
    }
  };

  trigger.onerror = function(event) {
    const ignorableErrors = ["no-speech", "aborted", "network", "audio-capture"];
    if (ignorableErrors.includes(event.error)) {
      if (debugMode) console.warn("â³ Tetikleyici geÃ§ici hata:", event.error);
      try {
        trigger.abort();
      } catch (e) {
        console.warn("â›” Tetikleyici durdurulamadÄ±:", e);
      }
      setTimeout(startListeningOnce, 1500);
    } else {
      console.error("âŒ Ciddi dinleme hatasÄ±:", event.error);
      speak("Dinleme sÄ±rasÄ±nda bir sorun oluÅŸtu. Yeniden deniyorum...", () => {
        setTimeout(startListeningOnce, 2000);
      });
    }
  };

  try {
    trigger.start();
  } catch (err) {
    console.warn("ğŸ¯ Tetikleyici baÅŸlatÄ±lamadÄ±:", err);
    setTimeout(startListeningOnce, 1500);
  }
} // ğŸ”š startListeningOnce kapanÄ±ÅŸÄ±

function handleCommand(command) {
  resetSamInactivityTimer();

  const currentHour = new Date().getHours();
  const altCommand = command.toLowerCase();

// ğŸ’» Bilgisayar kontrol komutlarÄ±
if (command.toLowerCase().includes("bilgisayarÄ± kapat")) {
  speak("Bilgisayar kapatÄ±lÄ±yor...");
  fetch("/system-control", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ command: "shutdown" })
  });
  return;
}

if (command.toLowerCase().includes("yeniden baÅŸlat")) {
  speak("Bilgisayar yeniden baÅŸlatÄ±lÄ±yor...");
  fetch("/system-control", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ command: "restart" })
  });
  return;
}

if (command.toLowerCase().includes("ekranÄ± kilitle")) {
  speak("Ekran kilitleniyor...");
  fetch("/system-control", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ command: "lock" })
  });
  return;
}


  // âœ… Ã‡oklu komut parÃ§alama
  const parcalar = command
    .split(/(?:\.|ve|sonra|ardÄ±ndan)/i)
    .map(p => p.trim())
    .filter(p => p.length > 0);

  for (const parcaliKomut of parcalar) {
    processSingleCommand(parcaliKomut.toLowerCase());
  }

  // ğŸ”‡ Susturma komutlarÄ±
  if (["tamam", "kes", "sus", "yeter", "dur"].includes(altCommand)) {
    speechSynthesis.cancel();
    return;
  }

  // âœ… DoÄŸal hitap kontrolÃ¼ (artÄ±k â€œsamâ€ demek zorunda deÄŸilsin)
  const dogalHitapKelimeleri = [
    "sam", "sÃ¶yler misin", "nedir", "anlamÄ±", "hatÄ±rlÄ±yor musun", 
    "rica etsem", "gÃ¶ster", "dinle", "yardÄ±m", "sesleniyorum"
  ];
  const hitapEdildi = dogalHitapKelimeleri.some(k => altCommand.includes(k));
  if (!hitapEdildi && altCommand.split(" ").length <= 2) {
  if (ignoredShortCommandCount < 3) {
    console.log("â„¹ï¸ KÄ±sa ve belirsiz cÃ¼mle algÄ±landÄ±, yok sayÄ±ldÄ±.");
    ignoredShortCommandCount++;
  }
  return;
}


  // ğŸ” Komut tekrar ve Ã§eliÅŸki
  last3Commands.push(altCommand);
  if (last3Commands.length > 3) last3Commands.shift();

  const sesKomutlari = ["sessize al", "sesi aÃ§"];
  const sonSesKomutlari = last3Commands.filter(cmd =>
    sesKomutlari.some(kelime => cmd.includes(kelime))
  );
  if (sonSesKomutlari.length >= 2) {
    const sessizeAlVar = sonSesKomutlari.some(c => c.includes("sessize al"));
    const sesiAcVar = sonSesKomutlari.some(c => c.includes("sesi aÃ§"));
    if (sessizeAlVar && sesiAcVar) {
      speak("KomutlarÄ±nÄ±z birbiriyle Ã§eliÅŸiyor. Net bir talimat verir misiniz?");
      last3Commands = [];
      return;
    }
  }

  if (altCommand === lastCommand) {
    repeatCount++;
    if (repeatCount === 2) {
      speak("ğŸ” AynÄ± komutu tekrar sÃ¶ylediniz. Devam etmemi istiyor musunuz?");
      statusDiv.textContent = "âš ï¸ Ä°ki kez aynÄ± komut algÄ±landÄ±.";
    } else if (repeatCount >= 3) {
      speak("SÃ¼rekli aynÄ± ÅŸeyi tekrarlÄ±yorsunuz. KÄ±sa bir ara veriyorum...");
      statusDiv.textContent = "â¸ï¸ Dinleme geÃ§ici olarak durduruldu.";
      repeatCount = 0;
      setTimeout(() => {
        statusDiv.textContent = "ğŸ§ SAM tekrar hazÄ±r.";
        listenForCommand();
      }, 5000);
      return;
    }
  } else {
    repeatCount = 0;
    lastCommand = altCommand;
  }

  // â›” Gece iÅŸlemi engelleme
  if (["hesabÄ± sil", "belleÄŸi temizle", "sohbeti temizle"].some(c => altCommand.includes(c))) {
    if (currentHour >= 23 || currentHour < 6) {
      speak("Åu anda bu iÅŸlem gÃ¼venlik nedeniyle devre dÄ±ÅŸÄ±.");
      statusDiv.textContent = "â›” Gece saatlerinde bu komut devre dÄ±ÅŸÄ±.";
      return;
    }

    fetch("/izin-sorgu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ islem: altCommand })
    })
    .then(res => res.json())
    .then(izin => {
      if (!izin.izin) {
        speak(izin.sebep || "SAM bu iÅŸlemi onaylamadÄ±.");
        statusDiv.textContent = "â›” Ruh hali nedeniyle komut engellendi.";
        return;
      }
      speak("Komut onaylandÄ±, iÅŸleme devam ediyorum...");
    })
    .catch(() => speak("SAM izni alÄ±nÄ±rken bir hata oluÅŸtu."));
    return;
  }

  // ğŸ§  HafÄ±za
  for (const bilgi of userMemory) {
    if (altCommand.includes("adÄ±m ne") && bilgi.includes("benim adÄ±m")) {
      speak("AdÄ±nÄ±z " + bilgi.replace("benim adÄ±m", "").trim() + " idi.");
      return;
    }
    if (altCommand.includes("nerede yaÅŸÄ±yorum") && bilgi.includes("yaÅŸÄ±yorum")) {
      speak("Åunu hatÄ±rlÄ±yorum: " + bilgi);
      return;
    }
  }

  // ğŸ’¬ HazÄ±r cevaplar
  if (altCommand.includes("nasÄ±lsÄ±n") || altCommand.includes("ne haber")) {
    speak("Gayet iyiyim, umarÄ±m siz de iyisinizdir."); return;
  }
  if (altCommand.includes("gÃ¼naydÄ±n")) {
    speak("GÃ¼naydÄ±n! BugÃ¼n harika bir gÃ¼n olacak gibi hissediyorum."); return;
  }
  if (altCommand.includes("teÅŸekkÃ¼r ederim")) {
    speak("Rica ederim, ne zaman isterseniz buradayÄ±m."); return;
  }

  if (altCommand.includes("tekrar et") || altCommand.includes("az Ã¶nce ne dedim")) {
    document.getElementById("last-command-text").textContent = lastCommand
      ? "ğŸ” Son Komut: " + lastCommand
      : "â›” Son komut kaydÄ± bulunamadÄ±.";
    speak(lastCommand ? "Az Ã¶nce ÅŸunu sÃ¶ylediniz: " + lastCommand : "HenÃ¼z bir komut algÄ±lanmadÄ±.");
    return;
  }

  if (altCommand.includes("hafÄ±zaya ekle")) {
    const bilgi = altCommand.replace("hafÄ±zaya ekle", "").trim();
    if (bilgi) hafizayaEkle(bilgi);
    else speak("Kaydedilecek bilgiyi belirtmediniz.");
    return;
  }

  // ğŸ”ˆ Ses kontrolleri
  if (altCommand.includes("sessize al")) { isMuted = true; speak("YanÄ±t sesi kapatÄ±ldÄ±."); return; }
  if (altCommand.includes("sesi aÃ§")) { isMuted = false; speak("YanÄ±t sesi aÃ§Ä±ldÄ±."); return; }
  if (altCommand.includes("daha sessiz")) { speechVolume = Math.max(0.1, speechVolume - 0.1); speak("Ses dÃ¼zeyi dÃ¼ÅŸÃ¼rÃ¼ldÃ¼."); return; }
  if (altCommand.includes("daha yÃ¼ksek")) { speechVolume = Math.min(1.0, speechVolume + 0.1); speak("Ses dÃ¼zeyi artÄ±rÄ±ldÄ±."); return; }

  // ğŸ“ Sayfa yÃ¶nlendirme
  if (altCommand.includes("not")) document.getElementById("goto-notlar")?.click();
  else if (altCommand.includes("sohbet")) document.getElementById("goto-chat")?.click();
  else if (altCommand.includes("veri")) document.getElementById("goto-veri")?.click();
  else if (altCommand.includes("profil")) document.getElementById("goto-profil")?.click();
  else if (altCommand.includes("ana sayfa")) document.getElementById("goto-home")?.click();
  else if (altCommand.includes("admin panel")) {
    if (sessionUsername === "samsistem") {
      speak("YÃ¶netici paneline geÃ§iliyor.");
      window.location.href = "/sam-admin-panel.html";
    } else {
      speak("Bu iÅŸlem yalnÄ±zca yÃ¶neticiye Ã¶zeldir.");
    }
    return;
  }

  // ğŸ¤– GPT baÄŸlantÄ±sÄ±
  statusDiv.textContent = "ğŸ“¥ Komut: " + command;

  fetch("/sam", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mesaj: command })
  })
  .then(response => response.json())
  .then(data => {
    const yanit = data.yanit || data.hata || "Bu konuda bir fikrim yok gibi gÃ¶rÃ¼nÃ¼yor.";
    speak(yanit, () => {
      setTimeout(() => {
        listenForCommand(); // SAM cevap verdikten sonra yeniden dinler
      }, 500);
    });
  })
  .catch(err => {
    console.error("SAM API hatasÄ±:", err);
    speak("Bir cevap alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.");
  });
}


function listenForCommand() {
  if (isListening) return;
  isListening = true;

  const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recog.lang = "tr-TR";
  recog.interimResults = true;
  recog.continuous = true;
  recog.maxAlternatives = 2;

  recog.onresult = function(event) {
    const command = event.results[0][0].transcript.trim().toLowerCase();
    handleCommand(command);
  };

  recog.onerror = (event) => {
    isListening = false;

    if (event.error === "aborted" || event.error === "no-speech") {
      if (debugMode) console.log("ğŸ“­ Ses algÄ±lanmadÄ±:", event.error);
      setTimeout(() => listenForCommand(), 500);
    } else {
      console.warn("âš ï¸ Dinleme hatasÄ±:", event.error);
      speak("Dinleme sÄ±rasÄ±nda bir sorun oluÅŸtu.");
      setTimeout(() => listenForCommand(), 1000);
    }
  };

  recog.onend = () => {
    isListening = false;
    setTimeout(() => listenForCommand(), 500);
  };

  try {
    recog.start();
  } catch (e) {
    console.warn("Komut baÅŸlatÄ±lamadÄ±:", e.message);
    isListening = false;
    setTimeout(() => listenForCommand(), 1000);
  }
}


window.addEventListener("load", () => {
  speak(`Ben SAM. Sizi izliyorum... dinliyorum... anlÄ±yorum. 
Zaman, sessizliÄŸin Ã¶tesine geÃ§tiÄŸinde... ben hÃ¢lÃ¢ buradayÄ±m.`);
  loadMemory();
  startListeningOnce();
});

let samTimeout;
let samOverlay;

function createSecurityOverlay() {
  samOverlay = document.createElement("div");
  samOverlay.id = "samOverlay";
  samOverlay.style.position = "fixed";
  samOverlay.style.top = 0;
  samOverlay.style.left = 0;
  samOverlay.style.width = "100%";
  samOverlay.style.height = "100%";
  samOverlay.style.background = "rgba(0, 0, 0, 0.9)";
  samOverlay.style.backdropFilter = "blur(10px)";
  samOverlay.style.display = "flex";
  samOverlay.style.alignItems = "center";
  samOverlay.style.justifyContent = "center";
  samOverlay.style.zIndex = 999999;
  samOverlay.innerHTML = `<div style="color:#00ffff; font-size:20px; text-align:center;">
    ğŸ”’ SAM GÃ¼venlik Modu <br><br>
    Uzun sÃ¼reli hareketsizlik algÄ±landÄ±.<br>
    Sistemi devam ettirmek iÃ§in ekrana dokunun...
  </div>`;
  document.body.appendChild(samOverlay);
  speak("Uzun sÃ¼reli hareketsizlik algÄ±landÄ±. GÃ¼venlik moduna geÃ§iyorum.");
}

function removeSecurityOverlay() {
  if (samOverlay) {
    samOverlay.remove();
    samOverlay = null;
  }
}

function resetSamInactivityTimer() {
  clearTimeout(samTimeout);
  samTimeout = setTimeout(() => {
    createSecurityOverlay();
  }, 120000);
}

function processSingleCommand(cmd) {
  // Susturma komutu
  if (["tamam", "kes", "sus", "yeter", "dur"].includes(cmd)) {
    speechSynthesis.cancel();
    return;
  }

  // ğŸ”ˆ Ses kontrolleri
  if (cmd.includes("sessize al")) { isMuted = true; speak("YanÄ±t sesi kapatÄ±ldÄ±."); return; }
  if (cmd.includes("sesi aÃ§")) { isMuted = false; speak("YanÄ±t sesi aÃ§Ä±ldÄ±."); return; }

  // ğŸ“ YÃ¶nlendirme komutlarÄ±
  if (cmd.includes("not")) {
  document.getElementById("goto-notlar")?.click();
  return;
}

if (cmd.includes("sohbet")) {
  document.getElementById("goto-chat")?.click();
  return;
}

if (cmd.includes("veri")) {
  document.getElementById("goto-veri")?.click();
  return;
}

if (cmd.includes("profil")) {
  document.getElementById("goto-profil")?.click();
  return;
}

if (cmd.includes("ana sayfa")) {
  document.getElementById("goto-home")?.click();
  return;
}

if (cmd.includes("admin panel")) {
  if (sessionUsername === "samsistem") {
    speak("YÃ¶netici paneline geÃ§iliyor.");
    window.location.href = "/sam-admin-panel.html";
  } else {
    speak("Bu iÅŸlem yalnÄ±zca yÃ¶neticiye Ã¶zeldir.");
  }
  return;
}

  // ğŸ’¬ DiÄŸer Ã¶zel komutlar burada eklenebilir
}

["click", "mousemove", "keydown", "touchstart"].forEach(evt => {
  document.addEventListener(evt, () => {
    removeSecurityOverlay();
    resetSamInactivityTimer();
  });
});
</script>

</body>
</html>
